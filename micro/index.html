<head>
    <style>
        button.true {
            background-color: red;
        }
        button {

        }
        #UI > DIV {
            margin-top: 10px;
            border: 1px solid black;
        }
        DIV.BITSTRING > SPAN {
            margin-right: 10px;
        }
        SPAN.true {
            background-color: red;
        }
        SPAN.reading {
            background-color: lightblue;
        }
    </style>
    <script src='/lib/signature_parser.js'></script>
    <script src='/lib/TypesBaseDatatypes.js'></script>
    <script src='/lib/TypesManagementDatatypes.js'></script>
    <script src='/lib/TypesFrameworkDatatypes.js'></script>
    <script src='/lib/TypesAgentDatatypes.js'></script>
    <script src='/lib/TypesBlockandMatrixDatatypes.js'></script>
    <script src='/lib/TypesEvent&SubscriptionDatatypes.js'></script>
    <script src='/lib/TypesWorkerDatatypes.js'></script>
    <script src='/lib/TypesLibraryDatatypes.js'></script>
    <script src='/lib/TypesNetworkDatatypes.js'></script>
    <script src='/lib/TypesSamplingDatatypes.js'></script>
    <script src='/lib/TypesTaskDatatypes.js'></script>
    <script src='/lib/RemoteControlClasses.js'></script>
    <script src='/lib/OCA.js'></script>
    <script src='/lib/WebSocket.js'></script>
    <script>
        var ws = new WebSocket('ws://'+document.location.host);

        var objects;

        function bitstring_actuator(o) {
            var DIV = document.createElement("DIV");
            DIV.classList.add("BITSTRING");
            DIV.classList.add("ACTUATOR");
            var role = document.createElement("SPAN");
            DIV.appendChild(role);

            o.GetRole().then(function(r) {
                role.appendChild(document.createTextNode(r + " ( " + o.ObjectNumber + " ) " ));
            });
            o.GetNrBits().then(function(N) {
                var S;
                var update_state = function(state) {
                    console.log("received state for object %o:", o.ObjectNumber, state);
                    S = state;
                    for (var i = 0; i < S.length; i++) {
                        B[i].classList.toggle("true", state[i]);
                    }
                };
                var B = [];
                for (var index = 0; index < N; index++) {
                    var b = document.createElement("button");
                    B[index] = b;


                    b.appendChild(document.createTextNode("LED "+index));
                    b.addEventListener("click", function(index) {
                        var state = this.classList.contains("true");
                        o.SetBit(index, !state);
                    }.bind(b, index));

                    DIV.appendChild(b);
                }
                o.on_property_changed("Bitstring", update_state).catch(function(err) { OCA.error("Subscription failed", err); });
                o.GetBitstring().then(update_state);
            });
            return DIV;
        }
        
        function bitstring_sensor(o) {
            var DIV = document.createElement("DIV");
            DIV.classList.add("BITSTRING");
            DIV.classList.add("SENSOR");
            var role = document.createElement("SPAN");
            DIV.appendChild(role);

            o.GetRole().then(function(r) {
                role.appendChild(document.createTextNode(r + " ( " + o.ObjectNumber + " ) " ));
            });
            o.GetNrBits().then(function(N) {
                var S;
                var update_state = function(state) {
                    console.log("received state for object %o:", o.ObjectNumber, state);
                    S = state;
                    for (var i = 0; i < S.length; i++) {
                        B[i].classList.toggle("true", state[i]);
                    }
                };
                var B = [];
                for (var index = 0; index < N; index++) {
                    var b = document.createElement("SPAN");
                    b.classList.add("SENSOR");
                    B[index] = b;


                    b.appendChild(document.createTextNode(index));
                    DIV.appendChild(b);
                }
                o.on_property_changed("BitString", update_state).catch(function(err) { OCA.error("Subscription failed", err); });
                o.GetBitString().then(update_state);
            });
            return DIV;
        }

        function int8_sensor(o) {
            var DIV = document.createElement("DIV");
            DIV.classList.add("INT8");
            DIV.classList.add("SENSOR");
            var role = document.createElement("SPAN");
            DIV.appendChild(role);
            var reading = document.createElement("SPAN");
            reading.classList.add("reading");
            DIV.appendChild(reading);

            o.GetRole().then(function(r) {
                role.appendChild(document.createTextNode(r + " ( " + o.ObjectNumber + " ) " ));
            });
            var update_reading = function(val) {
                var pos = (val + 128) / 2.55;
                reading.style["margin-left"] = (pos*10) + "px";
                reading.textContent = val;
            }
            o.on_property_changed("Reading", update_reading).catch(function(err) { OCA.error("Subscription failed", err); });
            o.GetReading().then(update_reading);
            return DIV;
        }

        ws.onopen = function() {
            window.device = new OCA.RemoteDevice(new OCA.WebSocketConnection(ws));

            device.discover_all().then(function (res) {
                objects = res;
                window.objects = res;
                var text = 'Found '+objects.length+' Objects: \n';

                for (var i = 0; i < res.length; i++) {
                    text += res[i].ClassName + ' with ObjectNumber ' + res[i].ObjectNumber + '\n';
                }

                document.getElementById('messages').innerHTML = text;

                var UI = document.getElementById("UI");

                for (var i = 0; i < objects.length; i++) {
                    var o = objects[i];
                    if (o instanceof OCA.ControlClasses.OcaBitstringActuator) {
                        UI.appendChild(bitstring_actuator(o));
                    } else if (o instanceof OCA.ControlClasses.OcaBitstringSensor) {
                        UI.appendChild(bitstring_sensor(o));
                    } else if (o instanceof OCA.ControlClasses.OcaInt8Sensor) {
                        UI.appendChild(int8_sensor(o));
                    }
                }

            }).catch(function(res) { console.error(res); });
        };
    </script>
    <body>
        <h1> This is a simple sample interface representing the OCA PI Microdemo</h1>

        <div id=UI>
        </div>

        <pre id='messages'>
        </pre>

    </body>
</head>
